#!/bin/bash
set -e

PROGPATH=$(realpath "$0")
PROGDIR=$(dirname "${PROGPATH}")

ARG_LANG_PRESENT=false
for a in "$@"; do
    case "$a" in
        --lang|--lang=*) ARG_LANG_PRESENT=true ;;
    esac
done

ORIG_LANG="${LANG-}"
KNOWN_ARGS=( samples batch-size data-dir lang phrase )
source "${PROGDIR}/shell.functions"
MWW_LANG_INPUT=""
if ${ARG_LANG_PRESENT}; then
    MWW_LANG_INPUT="${LANG-}"
fi
MWW_PHRASE_INPUT="${PHRASE-}"

if [ -n "${ORIG_LANG}" ] ; then
    export LANG="${ORIG_LANG}"
else
    unset LANG || :
fi

WAKE_WORD="${POSITIONAL_ARGS[0]}"

if [ ${#UNKNOWN_ARGS[@]} -gt 0 ] ; then
    echo "Unknown argument(s): ${UNKNOWN_ARGS[*]}" >&2
    HELP=true
fi

if [ "${HELP}" == "true" ] || [ -z "${WAKE_WORD}" ] ; then
    cat <<EOF >&2
Usage: $0 [ --samples=<samples> ] [ --batch-size=<batch_size> ]
          [ --lang=<lang> ] [ --phrase=<phrase> ] <wake_word>

--samples:            The number of samples to generate for the wake word.
                      Default: ${DEFAULT_SAMPLES}

--batch-size:         How many samples should be generated at a time.  The more
                      samples, the more memory is needed.
                      Default: ${DEFAULT_BATCH_SIZE}

<wake_word>           The word to generate samples for.
                      Required.

EOF
    exit 1
fi

# shellcheck source=/dev/null
source "${DATA_DIR}/.venv/bin/activate"

WORK_DIR="${DATA_DIR}/work"
mkdir -p "${WORK_DIR}" || :
cd "${WORK_DIR}"

PSG="${DATA_DIR}/tools/piper-sample-generator"
MODELS_DIR="${PSG}/models"
mkdir -p "${MODELS_DIR}" || :

TARGET_PHRASE="${MWW_PHRASE_INPUT:-${MWW_PHRASE:-${WAKE_WORD}}}"
TARGET_LANG="$(echo "${MWW_LANG_INPUT:-${MWW_LANG:-auto}}" | tr '[:upper:]' '[:lower:]')"

if [ -z "${TARGET_LANG}" ] ; then
    TARGET_LANG="auto"
fi

if [ "${TARGET_LANG}" = "auto" ] ; then
    TARGET_LANG="$(
        python - <<'PY' "${TARGET_PHRASE}"
import re, sys
phrase = sys.argv[1] if len(sys.argv) > 1 else ""
print("ru" if re.search(r"[А-Яа-яЁё]", phrase) else "en")
PY
    )"
fi

case "${TARGET_LANG}" in
    en|ru) : ;;
    *) echo "ERROR: Unsupported --lang: ${TARGET_LANG} (use en|ru|auto)" >&2; exit 1 ;;
esac

if [ "${TARGET_LANG}" = "ru" ] ; then
    MODEL_NAME="ru_RU-dmitri-medium.onnx"
    MODEL_FILE="${MODELS_DIR}/${MODEL_NAME}"
    MODEL_URL="https://huggingface.co/rhasspy/piper-voices/resolve/main/ru/ru_RU/dmitri/medium/${MODEL_NAME}"
else
    MODEL_NAME="en_US-libritts_r-medium.pt"
    MODEL_FILE="${MODELS_DIR}/${MODEL_NAME}"
    MODEL_URL="https://github.com/rhasspy/piper-sample-generator/releases/download/v2.0.0/${MODEL_NAME}"
fi
SAMPLES_DIR="${WORK_DIR}/wake_word_samples"

mkdir -p "${SAMPLES_DIR}" || :

REGENERATE=false

if [ "${SAMPLES}" -eq 1 ] ; then
    echo "===== Generating ${SAMPLES} sample of '${TARGET_PHRASE}' ====="
    sample_id="${MWW_SAFE_ID:-${WAKE_WORD}}"
    wake_word_filename="${sample_id//[ \`~\!\$&*\(\)\{\}\[\]\|\;\'\"<>.?\/]/_}"

    mkdir -p "${WORK_DIR}/test_sample" || :
    "${PSG}/generate_samples.py" "${TARGET_PHRASE}" \
        --model "${MODEL_FILE}" \
        --max-samples ${SAMPLES} \
        --batch-size ${BATCH_SIZE} \
        --output-dir "${WORK_DIR}/test_sample" \
        --max-speakers 100 2>&1 | sed -r -e "s/(DEBUG|INFO):__main__:/      /g"
    mv "${WORK_DIR}/test_sample/0.wav" "${WORK_DIR}/test_sample/${wake_word_filename}.wav"
    echo "Sample available at ${WORK_DIR}/test_sample/${wake_word_filename}.wav"
    echo "Play it from your host."
    exit 0
fi

if [ ! -f "${MODEL_FILE}" ] ; then
    echo "      Downloading ${MODEL_NAME} for piper-sample-generator"
    wcurl --curl-options="-s --clobber --continue-at -" "${MODEL_URL}" -o "${MODEL_FILE}"
fi

if [ ! -f "${MODEL_FILE}.json" ] ; then
    echo "      Downloading ${MODEL_NAME}.json for piper-sample-generator"
    wcurl --curl-options="-s --clobber --continue-at -" "${MODEL_URL}.json" -o "${MODEL_FILE}.json"
fi

grep -qF "${TARGET_PHRASE}:${SAMPLES}:${MODEL_NAME}" "${WORK_DIR}/last_wake_word" &>/dev/null || REGENERATE=true

# Double check that the number of existing samples matches SAMPLES"
existing_samples=$(find "${SAMPLES_DIR}" -name '*.wav' | wc -l)
[ "${existing_samples}" -eq "${SAMPLES}" ] || REGENERATE=true

START_TS=$EPOCHSECONDS

if ! ${REGENERATE} ; then
    echo "Sample generation not required"
    echo
    exit 0
fi

echo -e "\n===== Generating ${SAMPLES} wake word samples in batches of ${BATCH_SIZE}  ====="
export TF_CPP_MIN_LOG_LEVEL=9
export TF_FORCE_GPU_ALLOW_GROWTH=true
export TF_GPU_ALLOCATOR=cuda_malloc_async
export TF_XLA_FLAGS="--tf_xla_auto_jit=0"
export NVIDIA_TF32_OVERRIDE=1
export TF_CUDNN_WORKSPACE_LIMIT_IN_MB=512
export GLOG_minloglevel=2
export GRPC_VERBOSITY=ERROR

echo "   Generating samples"
rm -rf "${SAMPLES_DIR}" || :
mkdir -p "${SAMPLES_DIR}" || :
"${PSG}/generate_samples.py" "${TARGET_PHRASE}" \
    --model "${MODEL_FILE}" \
    --max-samples ${SAMPLES} \
    --batch-size ${BATCH_SIZE} \
    --output-dir "${SAMPLES_DIR}" 2>&1 | sed -r -e "s/(DEBUG|INFO):__main__:/      /g"

generated_files=$(find "${SAMPLES_DIR}" -name '*.wav' | wc -l)
if [ "${generated_files}" -ne "${SAMPLES}" ] ; then
    echo "ERROR:  only generated ${generated_files} files" >&2
    exit 1
fi
END_TS=$(date +%s.%N)
echo "${TARGET_PHRASE}:${SAMPLES}:${MODEL_NAME}" > "${WORK_DIR}/last_wake_word"
echo
END_TS=$EPOCHSECONDS
print_elapsed_time "${START_TS}" "${END_TS}" "Generated ${SAMPLES} wake word samples."

exit 0
